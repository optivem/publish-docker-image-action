name: 'Publish Docker Image'
description: 'Builds Docker image and pushes to container registry with automatic tagging'
author: 'Optivem'
branding:
  icon: 'upload-cloud'  # Choose from Feather icons
  color: 'blue'         # Brand color
inputs:
  working-directory:
    description: 'Working directory where Dockerfile is located'
    required: false
    default: '.'
  image-name:
    description: 'Name of the Docker image (without registry prefix)'
    required: true
  registry:
    description: 'Container registry URL (e.g., ghcr.io, docker.io, gcr.io)'
    required: false
    default: 'ghcr.io'
  registry-username:
    description: 'Username for registry authentication'
    required: false
    default: '${{ github.actor }}'
  image-namespace:
    description: 'Namespace/organization for the image (e.g., github.repository for GHCR)'
    required: false
    default: '${{ github.repository }}'
  commit-sha:
    description: 'Git commit SHA for image tagging'
    required: false
    default: '${{ github.sha }}'
  image-latest-tag:
    description: 'Tag to apply for the latest image (single value, e.g., "latest")'
    required: false
    default: 'latest'
  dockerfile:
    description: 'Path to Dockerfile relative to working directory'
    required: false
    default: 'Dockerfile'
outputs:
  image-latest-url:
    description: 'Full URL of the pushed Docker image with latest tag'
    value: '${{ steps.tag.outputs.latest-image-url }}'
  image-digest-url:
    description: 'Full URL with SHA256 digest of the pushed image'
    value: '${{ inputs.registry }}/${{ inputs.image-namespace }}/${{ inputs.image-name }}@${{ steps.push.outputs.digest }}'
runs:
  using: 'composite'
  steps:
    - name: Echo Information
      run: |
        echo "ğŸ³ Starting Docker build and push action"
        echo "ğŸ“¦ Image name: ${{ inputs.image-name }}"
        echo "ğŸ“ Working directory: ${{ inputs.working-directory }}"
        echo "ğŸ³ Dockerfile: ${{ inputs.dockerfile }}"
        echo "ğŸ”– Git SHA: ${{ inputs.commit-sha }}"
        echo "ğŸ·ï¸ Latest tag: ${{ inputs.image-latest-tag }}"
        echo "ğŸŒ Registry: ${{ inputs.registry }}"
        echo "ğŸ“ Namespace: ${{ inputs.image-namespace }}"
        echo "ğŸ‘¤ Username: ${{ inputs.registry-username }}"
      shell: bash

    - name: Build the Docker image
      run: |
        echo "ğŸ”¨ Building Docker image..."
        docker build . --file ${{ inputs.dockerfile }} --tag ${{ inputs.image-name }}:${{ inputs.commit-sha }}
        echo "âœ… Docker image built successfully"
      shell: bash
      working-directory: ${{ inputs.working-directory }}

    - name: Log in to Container Registry
      run: |
        echo "ğŸ” Logging in to ${{ inputs.registry }}..."
        echo $REGISTRY_PASSWORD | docker login ${{ inputs.registry }} -u ${{ inputs.registry-username }} --password-stdin
        echo "âœ… Successfully logged in to registry"
      shell: bash
      env:
        REGISTRY_PASSWORD: ${{ env.REGISTRY_PASSWORD }}

    - name: Tag Docker image
      id: tag
      run: |
        # Create base image reference
        BASE_IMAGE="${{ inputs.registry }}/${{ inputs.image-namespace }}/${{ inputs.image-name }}"
        
        # Construct the latest image URL
        LATEST_IMAGE_URL="${BASE_IMAGE}:${{ inputs.image-latest-tag }}"
        echo "latest-image-url=$LATEST_IMAGE_URL" >> $GITHUB_OUTPUT
        
        # Tag with SHA
        docker tag ${{ inputs.image-name }}:${{ inputs.commit-sha }} "${BASE_IMAGE}:${{ inputs.commit-sha }}"
        echo "ğŸ·ï¸ Tagged with SHA: ${BASE_IMAGE}:${{ inputs.commit-sha }}"
        
        # Tag with latest tag
        docker tag ${{ inputs.image-name }}:${{ inputs.commit-sha }} "$LATEST_IMAGE_URL"
        echo "ğŸ·ï¸ Tagged with: $LATEST_IMAGE_URL"
      shell: bash

    - name: Push Docker image
      id: push
      run: |
        BASE_IMAGE="${{ inputs.registry }}/${{ inputs.image-namespace }}/${{ inputs.image-name }}"
        
        echo "ğŸ“¤ Pushing Docker images..."
        
        # Push SHA tagged image
        docker push "${BASE_IMAGE}:${{ inputs.commit-sha }}"
        echo "âœ… Pushed SHA tagged image: ${BASE_IMAGE}:${{ inputs.commit-sha }}"
        
        # Push latest tagged image
        docker push "${{ steps.tag.outputs.latest-image-url }}"
        echo "âœ… Pushed tagged image: ${{ steps.tag.outputs.latest-image-url }}"
        
        echo "ğŸ‰ Successfully pushed all Docker images to ${{ inputs.registry }}"
        echo "ğŸ“¦ Main image URL: ${{ steps.tag.outputs.latest-image-url }}"
      shell: bash

    - name: Output Summary
      run: |
        echo "ğŸ“‹ Action Outputs Summary:"
        echo "========================="
        echo "ğŸ”— Image Latest URL: ${{ steps.tag.outputs.latest-image-url }}"
        echo "ğŸ”— Image Digest URL: ${{ inputs.registry }}/${{ inputs.image-namespace }}/${{ inputs.image-name }}@${{ steps.push.outputs.digest }}"
        echo "========================="
      shell: bash