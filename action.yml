name: 'Build and Push Docker Image'
description: 'Builds Docker image, logs in to GitHub Container Registry, and pushes the image with automatic tagging'
author: 'Optivem'
branding:
  icon: 'upload-cloud'  # Choose from Feather icons
  color: 'blue'         # Brand color
inputs:
  working-directory:
    description: 'Working directory where Dockerfile is located'
    required: false
    default: '.'
  image-name:
    description: 'Name of the Docker image (without registry prefix)'
    required: true
  github-token:
    description: 'GitHub token for registry authentication (use secrets.GITHUB_TOKEN)'
    required: true
  github-actor:
    description: 'GitHub actor for registry authentication (use github.actor)'
    required: true
  github-repository:
    description: 'GitHub repository for image tagging (use github.repository)'
    required: true
  github-sha:
    description: 'GitHub SHA for image tagging (use github.sha)'
    required: true
outputs:
  image-url:
    description: 'Full URL of the pushed Docker image'
    value: 'ghcr.io/${{ inputs.github-repository }}/${{ inputs.image-name }}:latest'
  image-digest:
    description: 'SHA256 digest of the pushed image'
    value: ${{ steps.push.outputs.digest }}
runs:
  using: 'composite'
  steps:
    - name: Echo Information
      run: |
        echo "ğŸ³ Starting Docker build and push action"
        echo "ğŸ“¦ Image name: ${{ inputs.image-name }}"
        echo "ğŸ“ Working directory: ${{ inputs.working-directory }}"
        echo "ğŸ”– Git SHA: ${{ inputs.github-sha }}"
        echo "ğŸ“ Repository: ${{ inputs.github-repository }}"
      shell: bash

    - name: Build the Docker image
      run: |
        echo "ğŸ”¨ Building Docker image..."
        docker build . --file Dockerfile --tag ${{ inputs.image-name }}:${{ inputs.github-sha }}
        echo "âœ… Docker image built successfully"
      shell: bash
      working-directory: ${{ inputs.working-directory }}

    - name: Log in to GitHub Container Registry
      run: |
        echo "ğŸ” Logging in to GitHub Container Registry..."
        echo ${{ inputs.github-token }} | docker login ghcr.io -u ${{ inputs.github-actor }} --password-stdin
        echo "âœ… Successfully logged in to GHCR"
      shell: bash

    - name: Tag Docker image
      run: |
        docker tag ${{ inputs.image-name }}:${{ inputs.github-sha }} ghcr.io/${{ inputs.github-repository }}/${{ inputs.image-name }}:latest
        docker tag ${{ inputs.image-name }}:${{ inputs.github-sha }} ghcr.io/${{ inputs.github-repository }}/${{ inputs.image-name }}:${{ inputs.github-sha }}
        echo "ğŸ·ï¸ Tagged image with both 'latest' and SHA tags"
      shell: bash

    - name: Push Docker image
      id: push
      run: |
        docker push ghcr.io/${{ inputs.github-repository }}/${{ inputs.image-name }}:latest
        docker push ghcr.io/${{ inputs.github-repository }}/${{ inputs.image-name }}:${{ inputs.github-sha }}
        echo "âœ… Successfully pushed Docker image to GitHub Container Registry"
        echo "ğŸ“¦ Image URL: ghcr.io/${{ inputs.github-repository }}/${{ inputs.image-name }}:latest"
      shell: bash