name: 'Publish Docker Image'
description: 'Builds Docker         echo "ğŸ“ Working directory: ${{ inputs.working-directory }}"
        echo "ğŸ³ Dockerfile: ${{ inputs.dockerfile }}"
        echo "ğŸ”– Git SHA: ${{ inputs.commit-sha }}"
        echo "ğŸ·ï¸ Latest tag: ${{ inputs.image-latest-tag }}"e and pushes to container registry with automatic tagging'
author: 'Optivem'
branding:
  icon: 'upload-cloud'  # Choose from Feather icons
  color: 'blue'         # Brand color
inputs:
  working-directory:
    description: 'Working directory where Dockerfile is located'
    required: false
    default: '.'
  image-name:
    description: 'Name of the Docker image (without registry prefix)'
    required: true
  registry:
    description: 'Container registry URL (e.g., ghcr.io, docker.io, gcr.io)'
    required: false
    default: 'ghcr.io'
  registry-username:
    description: 'Username for registry authentication'
    required: false
    default: '${{ github.actor }}'
  registry-password:
    description: 'Password/token for registry authentication'
    required: true
  image-namespace:
    description: 'Namespace/organization for the image (e.g., github.repository for GHCR)'
    required: false
    default: '${{ github.repository }}'
  commit-sha:
    description: 'Git commit SHA for image tagging'
    required: false
    default: '${{ github.sha }}'
  image-latest-tag:
    description: 'Tag to apply for the latest image (single value, e.g., "latest")'
    required: false
    default: 'latest'
  dockerfile:
    description: 'Path to Dockerfile relative to working directory'
    required: false
    default: 'Dockerfile'
outputs:
  image-url:
    description: 'Full URL of the pushed Docker image'
    value: '${{ inputs.registry }}/${{ inputs.image-namespace }}/${{ inputs.image-name }}:${{ inputs.image-latest-tag }}'
  image-digest-url:
    description: 'Full URL with SHA256 digest of the pushed image'
    value: '${{ inputs.registry }}/${{ inputs.image-namespace }}/${{ inputs.image-name }}@${{ steps.push.outputs.digest }}'
  image-created:
    description: 'Timestamp when the Docker image was created'
    value: '${{ steps.inspect.outputs.image-created }}'
runs:
  using: 'composite'
  steps:
    - name: Echo Information
      run: |
        echo "ğŸ³ Starting Docker build and push action"
        echo "ğŸ“¦ Image name: ${{ inputs.image-name }}"
        echo "ğŸ“ Working directory: ${{ inputs.working-directory }}"
        echo "ï¿½ï¸ Dockerfile: ${{ inputs.dockerfile }}"
        echo "ï¿½ğŸ”– Git SHA: ${{ inputs.github-sha }}"
        echo "ğŸ·ï¸ Tags: ${{ inputs.tags }}"
        echo "ğŸŒ Registry: ${{ inputs.registry }}"
        echo "ğŸ“ Namespace: ${{ inputs.image-namespace }}"
        echo "ğŸ‘¤ Username: ${{ inputs.registry-username }}"
      shell: bash

    - name: Build the Docker image
      run: |
        echo "ğŸ”¨ Building Docker image..."
        docker build . --file ${{ inputs.dockerfile }} --tag ${{ inputs.image-name }}:${{ inputs.commit-sha }}
        echo "âœ… Docker image built successfully"
      shell: bash
      working-directory: ${{ inputs.working-directory }}

    - name: Inspect Docker image
      id: inspect
      run: |
        echo "ğŸ” Inspecting Docker image..."
        
        # Get image creation timestamp
        IMAGE_CREATED=$(docker inspect ${{ inputs.image-name }}:${{ inputs.commit-sha }} --format='{{.Created}}')
        echo "image-created=$IMAGE_CREATED" >> $GITHUB_OUTPUT
        echo "ğŸ“… Image created: $IMAGE_CREATED"
        
        echo "âœ… Image inspection completed"
      shell: bash

    - name: Log in to Container Registry
      run: |
        echo "ğŸ” Logging in to ${{ inputs.registry }}..."
        echo ${{ inputs.registry-password }} | docker login ${{ inputs.registry }} -u ${{ inputs.registry-username }} --password-stdin
        echo "âœ… Successfully logged in to registry"
      shell: bash

    - name: Tag Docker image
      run: |
        # Create base image reference
        BASE_IMAGE="${{ inputs.registry }}/${{ inputs.image-namespace }}/${{ inputs.image-name }}"
        
        # Tag with SHA
        docker tag ${{ inputs.image-name }}:${{ inputs.commit-sha }} "${BASE_IMAGE}:${{ inputs.commit-sha }}"
        echo "ğŸ·ï¸ Tagged with SHA: ${BASE_IMAGE}:${{ inputs.commit-sha }}"
        
        # Tag with latest tag
        docker tag ${{ inputs.image-name }}:${{ inputs.commit-sha }} "${BASE_IMAGE}:${{ inputs.image-latest-tag }}"
        echo "ğŸ·ï¸ Tagged with: ${BASE_IMAGE}:${{ inputs.image-latest-tag }}"
      shell: bash

    - name: Push Docker image
      id: push
      run: |
        BASE_IMAGE="${{ inputs.registry }}/${{ inputs.image-namespace }}/${{ inputs.image-name }}"
        
        echo "ğŸ“¤ Pushing Docker images..."
        
        # Push SHA tagged image
        docker push "${BASE_IMAGE}:${{ inputs.commit-sha }}"
        echo "âœ… Pushed SHA tagged image: ${BASE_IMAGE}:${{ inputs.commit-sha }}"
        
        # Push latest tagged image
        docker push "${BASE_IMAGE}:${{ inputs.image-latest-tag }}"
        echo "âœ… Pushed tagged image: ${BASE_IMAGE}:${{ inputs.image-latest-tag }}"
        
        echo "ğŸ‰ Successfully pushed all Docker images to ${{ inputs.registry }}"
        echo "ğŸ“¦ Main image URL: ${BASE_IMAGE}:latest"
      shell: bash